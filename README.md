# Stationeers IC10 Compiler (SICC)

[![CI](https://github.com/Alan-Chen99/sicc/actions/workflows/ci.yml/badge.svg)](https://github.com/Alan-Chen99/sicc/actions/workflows/ci.yml)
[![codecov](https://codecov.io/github/alan-chen99/sicc/graph/badge.svg?token=X8IE0XQ7NW)](https://codecov.io/github/alan-chen99/sicc)

SICC is yet another compiler for Stationeers IC10. It compiles to minimize code size.

This works by writing python code which gets **traced** and then compiled into IC10.
See [examples/explained.py](examples/explained.py) for how this works.

**This is a WIP; currently output may not be correct or even valid. API is subject to change without notice.**

## Example

here is a equivalent of the [ic11](https://github.com/Raibo/ic11) example [here](https://github.com/Raibo/ic11/wiki):

<table>
<th>Python</th>
<th>IC10</th>

<tr>
<td>

```python
from sicc import *
from sicc.devices import *

PA1 = d0
Valve1 = d1
PA2 = d2
Valve2 = d3

TargetTemp1 = 297
TargetTemp2 = 297


@program()
def Main():
    with loop():
        yield_()

        ControlTemp(PA1, Valve1, TargetTemp1)
        ControlTemp(PA2, Valve2, TargetTemp2)


@subr()
def ControlTemp(paIdx: Pin, valveIdx: Pin, targetTemp: Int):
    needCooling = paIdx.Temperature > targetTemp
    delta = abs(targetTemp - paIdx.Temperature)
    power = Variable(10)

    with if_(delta > 5):
        power.value = 100

    valveIdx.On = needCooling
    valveIdx.Setting = power
```

</td>
<td>

```asm
yield
move r1 0
move r0 1
jal 7
move r1 2
move r0 3
move ra 0
l r2 dr1 Temperature
slt r1 297 r2
sub r2 297 r2
abs r2 r2
move r3 10
ble r2 5 14
move r3 100
s dr0 On r1
s dr0 Setting r3
j ra
```

</td>
</tr>
</table>

this is **17** lines, compared to **29** lines (excluding aliases) generated by ic11

## Install (more options will be supported later)

Install [uv](https://github.com/astral-sh/uv) and run

```bash
git clone https://github.com/Alan-Chen99/sicc-template.git
cd sicc-template
uv sync
# optional: upgrade to latest git version
# uv lock --upgrade
source ./.venv/bin/activate
python main.py
# or: sicc main.py
```

## Project Goals

- free to write high-level constructs with bloat, and compile those away
- be able to utilize the whole instruction set, including conditional function calls
- efficient function calls without push and pop, by using another register as ra if ra is not available
- reorder instructions and blocks to save lines

## Internals

This compiler uses Static single-assignment form (SSA), but it does not have phi instructions; instead it has mutable variables (MVar) representing varaibles that opts out of SSA invariant. MVar must be first converted from/to Var before used; The register allocator (not created yet) will tries its best to allocate read/write mvar operands to the same register. MVar are printed with an underline in the current main.py output.

This project uses [uv](https://github.com/astral-sh/uv) to manage dependencies; so it is recommended to use uv to install dependencies locked in `uv.lock`

This codebase is statically typed; this works with pyright only.
